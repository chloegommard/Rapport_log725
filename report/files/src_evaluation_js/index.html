<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Plato - src\evaluation.js</title>

    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="" />
    <meta name="author" content="" />

    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <link href="../../assets/css/vendor/morris.css" rel="stylesheet" />
    <link href="../../assets/css/vendor/bootstrap.css" rel="stylesheet" />
    <link href="../../assets/css/vendor/font-awesome.css" rel="stylesheet" />
    <link href="../../assets/css/vendor/codemirror.css" rel="stylesheet" />
    <link href="../../assets/css/plato.css" rel="stylesheet" />
    <link href="../../assets/css/plato-file.css" rel="stylesheet" />
  </head>

  <body>
    <div class="navbar navbar-fixed-top">
      <div class="container">
        <a class="navbar-brand" href="http://github.com/es-analysis/plato"
          >Plato on Github</a
        >
        <ul class="nav navbar-nav">
          <li>
            <a href="../../index.html">Report Home</a>
          </li>
        </ul>
      </div>
    </div>

    <div class="jumbotron">
      <div class="container">
        <h1>src\evaluation.js</h1>
      </div>
    </div>

    <div class="container aggregate-stats">
      <div class="row">
        <div class="col-md-6">
          <h2 class="header">
            Maintainability
            <a
              href="http://blogs.msdn.com/b/codeanalysis/archive/2007/11/20/maintainability-index-range-and-meaning.aspx"
              ><i
                class="icon icon-info-sign"
                rel="popover"
                data-placement="top"
                data-trigger="hover"
                data-content="A value between 0 and 100 that represents the relative ease of maintaining the code. A high value means better maintainability."
                data-original-title="Maintainability Index"
                data-container="body"
              ></i
            ></a>
          </h2>
          <p class="stat">60.25</p>
        </div>
        <div class="col-md-6">
          <h2 class="header">
            Lines of code
            <i
              class="icon icon-info-sign"
              rel="popover"
              data-placement="top"
              data-trigger="hover"
              data-content="Source Lines of Code / Logical Lines of Code"
              data-original-title="SLOC/LSLOC"
              data-container="body"
            ></i>
          </h2>
          <p class="stat">345</p>
        </div>
      </div>
      <div class="row historical">
        <div class="col-md-6">
          <p id="chart_historical_maint" class="chart"></p>
        </div>
        <div class="col-md-6">
          <p id="chart_historical_sloc" class="chart"></p>
        </div>
      </div>
      <div class="row">
        <div class="col-md-6">
          <h2 class="header">
            Difficulty
            <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"
              ><i
                class="icon icon-info-sign"
                rel="popover"
                data-placement="top"
                data-trigger="hover"
                data-content="The difficulty measure is related to the difficulty of the program to write or understand."
                data-original-title="Difficulty"
                data-container="body"
              ></i
            ></a>
          </h2>
          <p class="stat">69.39</p>
        </div>
        <div class="col-md-6">
          <h2 class="header">
            Estimated Errors
            <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"
              ><i
                class="icon icon-info-sign"
                rel="popover"
                data-placement="top"
                data-trigger="hover"
                data-content="Halstead's delivered bugs is an estimate for the number of errors in the implementation."
                data-original-title="Delivered Bugs"
                data-container="body"
              ></i
            ></a>
          </h2>
          <p class="stat">3.96</p>
        </div>
      </div>
    </div>

    <div class="container charts">
      <div class="row">
        <h2 class="header">Function weight</h2>
      </div>
      <div class="row">
        <div class="col-md-6">
          <h3 class="chart-header">
            By Complexity
            <a href="http://en.wikipedia.org/wiki/Cyclomatic_complexity"
              ><i
                class="icon icon-info-sign"
                rel="popover"
                data-placement="top"
                data-trigger="hover"
                data-content="This metric counts the number of distinct paths through a block of code. Lower values are better."
                data-original-title="Cyclomatic Complexity"
                data-container="body"
              ></i
            ></a>
          </h3>
          <div id="fn-by-complexity" class="stat"></div>
        </div>
        <div class="col-md-6">
          <h3 class="chart-header">
            By SLOC
            <i
              class="icon icon-info-sign"
              rel="popover"
              data-placement="top"
              data-trigger="hover"
              data-content="Source Lines of Code / Logical Lines of Code"
              data-original-title="SLOC/LSLOC"
              data-container="body"
            ></i>
          </h3>
          <div id="fn-by-sloc" class="stat"></div>
        </div>
      </div>
    </div>

    <div class="container">
      <div class="row">
        <textarea id="file-source" class="col-md-12">
/* micropolisJS. Adapted by Graeme McCutcheon from Micropolis.
 *
 * This code is released under the GNU GPL v3, with some additional terms.
 * Please see the files LICENSE and COPYING for details. Alternatively,
 * consult http://micropolisjs.graememcc.co.uk/LICENSE and
 * http://micropolisjs.graememcc.co.uk/COPYING
 *
 */

import { EventEmitter } from &#039;./eventEmitter&#039;;
import { CLASSIFICATION_UPDATED, POPULATION_UPDATED, SCORE_UPDATED } from &#039;./messages&#039;;
import { MiscUtils } from &#039;./miscUtils&#039;;
import { Random } from &#039;./random&#039;;

var PROBLEMS = [&#039;CVP_CRIME&#039;, &#039;CVP_POLLUTION&#039;, &#039;CVP_HOUSING&#039;, &#039;CVP_TAXES&#039;,
                &#039;CVP_TRAFFIC&#039;, &#039;CVP_UNEMPLOYMENT&#039;, &#039;CVP_FIRE&#039;];
var NUMPROBLEMS = PROBLEMS.length;
var NUM_COMPLAINTS = 4;
var problemData = [];


var Evaluation = EventEmitter(function(gameLevel) {
  this.problemVotes = [];
  this.problemOrder = [];
  this.evalInit();
  this.gameLevel = &#039;&#039; + gameLevel;
});


Evaluation.prototype.cityEvaluation = function(simData) {
  var census = simData.census;

  if (census.totalPop &gt; 0) {
    for (var i = 0; i &lt; NUMPROBLEMS; i++)
      problemData.push(0);

    this.getAssessedValue(census);
    this.getPopulation(census);
    this.doProblems(simData.census, simData.budget, simData.blockMaps);
    this.getScore(simData);
    this.doVotes();
  } else {
    this.evalInit();
    this.cityYes = 50;
  }
};


Evaluation.prototype.evalInit = function() {
  this.cityYes = 0;
  this.cityPop = 0;
  this.cityPopDelta = 0;
  this.cityAssessedValue = 0;
  this.cityClass = Evaluation.CC_VILLAGE;
  this.cityClassLast = Evaluation.CC_VILLAGE;
  this.cityScore = 500;
  this.cityScoreDelta = 0;
  for (var i = 0; i &lt; NUMPROBLEMS; i++)
    this.problemVotes[i] = {index: i, voteCount: 0};

  for (i = 0; i &lt; NUM_COMPLAINTS; i++)
    this.problemOrder[i] = NUMPROBLEMS;
};


var saveProps = [&#039;cityClass&#039;, &#039;cityScore&#039;];

Evaluation.prototype.save = function(saveData) {
  for (var i = 0, l = saveProps.length; i &lt; l; i++)
    saveData[saveProps[i]] = this[saveProps[i]];
};


Evaluation.prototype.load = function(saveData) {
  for (var i = 0, l = saveProps.length; i &lt; l; i++)
    this[saveProps[i]] = saveData[saveProps[i]];
};


Evaluation.prototype.getAssessedValue = function(census) {
  var value;

  value = census.roadTotal * 5;
  value += census.railTotal * 10;
  value += census.policeStationPop * 1000;
  value += census.fireStationPop * 1000;
  value += census.hospitalPop * 400;
  value += census.stadiumPop * 3000;
  value += census.seaportPop * 5000;
  value += census.airportPop * 10000;
  value += census.coalPowerPop * 3000;
  value += census.nuclearPowerPop * 6000;

  this.cityAssessedValue = value * 1000;
};


Evaluation.prototype.getPopulation = function(census) {
  var oldPopulation = this.cityPop;
  this.cityPop = (census.resPop + (census.comPop + census.indPop) * 8) * 20;
  this.cityPopDelta = this.cityPop - oldPopulation;

  if (this.cityPopDelta !== 0)
    this._emitEvent(POPULATION_UPDATED, this.cityPop);

  return this.cityPop;
};


Evaluation.prototype.getCityClass = function(cityPopulation) {
  this.cityClass = Evaluation.CC_VILLAGE;

  if (cityPopulation &gt; 2000)
      this.cityClass = Evaluation.CC_TOWN;

  if (cityPopulation &gt; 10000)
      this.cityClass = Evaluation.CC_CITY;

  if (cityPopulation &gt; 50000)
      this.cityClass = Evaluation.CC_CAPITAL;

  if (cityPopulation &gt; 100000)
      this.cityClass = Evaluation.CC_METROPOLIS;

  if (cityPopulation &gt; 500000)
      this.cityClass = Evaluation.CC_MEGALOPOLIS;

  if (this.cityClass !== this.cityClassLast) {
    this.cityClassLast = this.cityClass;
    this._emitEvent(CLASSIFICATION_UPDATED, this.cityClass);
  }

  return this.cityClass;
};


Evaluation.prototype.voteProblems = function() {
  for (var i = 0; i &lt; NUMPROBLEMS; i++) {
    this.problemVotes[i].index = i;
    this.problemVotes[i].voteCount = 0;
  }

  var problem = 0;
  var voteCount = 0;
  var loopCount = 0;

  // Try to acquire up to 100 votes on problems, but bail if it takes too long
  while (voteCount &lt; 100 &amp;&amp; loopCount &lt; 600) {
    var voterProblemTolerance = Random.getRandom(300);
    if (problemData[problem] &gt; voterProblemTolerance) {
      // The voter is upset about this problem
      this.problemVotes[problem].voteCount += 1;
      voteCount++;
    }

    problem = (problem + 1) % NUMPROBLEMS;
    loopCount++;
  }
};


var getTrafficAverage = function(blockMaps, census) {
  var trafficDensityMap = blockMaps.trafficDensityMap;
  var landValueMap = blockMaps.landValueMap;

  var trafficTotal = 0;
  var count = 1;

  for (var x = 0; x &lt; landValueMap.gameMapWidth; x += landValueMap.blockSize) {
    for (var y = 0; y &lt; landValueMap.gameMapHeight; y += landValueMap.blockSize) {
      if (landValueMap.worldGet(x, y) &gt; 0) {
        trafficTotal += trafficDensityMap.worldGet(x, y);
        count++;
      }
    }
  }

  var trafficAverage = census.trafficAverage = Math.floor(trafficTotal / count) * 2.4;

  return trafficAverage;
};


var getUnemployment = function(census) {
  var b = (census.comPop + census.indPop) * 8;

  if (b === 0)
      return 0;

  // Ratio total people / working. At least 1.
  var r = census.resPop / b;

  b = Math.round((r - 1) * 255);
  return Math.min(b, 255);
};


var getFireSeverity = function(census) {
  return Math.min(census.firePop * 5, 255);
};


Evaluation.prototype.doProblems = function(census, budget, blockMaps) {
  problemData[Evaluation.CRIME]        = census.crimeAverage;
  problemData[Evaluation.POLLUTION]    = census.pollutionAverage;
  problemData[Evaluation.HOUSING]      = census.landValueAverage * 7 / 10;
  problemData[Evaluation.TAXES]        = budget.cityTax * 10;
  problemData[Evaluation.TRAFFIC]      = getTrafficAverage(blockMaps, census);
  problemData[Evaluation.UNEMPLOYMENT] = getUnemployment(census);
  problemData[Evaluation.FIRE]         = getFireSeverity(census);

  this.voteProblems();

  // Rank the problems
  this.problemVotes.sort(function(a, b) {
    return b.voteCount - a.voteCount;
  });

  this.problemOrder = this.problemVotes.map(function(pv, i) {
    if (i &gt;= NUM_COMPLAINTS || pv.voteCount === 0)
      return null;

    return pv.index;
  });
};


Evaluation.prototype.getScore = function(simData) {
  var census = simData.census;
  var budget = simData.budget;
  var valves = simData.valves;

  var cityScoreLast = this.cityScore;
  var score = 0;

  for (var i = 0; i &lt; NUMPROBLEMS; i++)
    score += problemData[i];

  score = Math.floor(score / 3);
  score = (250 - Math.min(score, 250)) * 4;

  // Penalise the player by 15% if demand for any type of zone is capped due
  // to lack of suitable buildings
  var demandPenalty = 0.85;

  if (valves.resCap)
    score = Math.round(score * demandPenalty);

  if (valves.comCap)
    score = Math.round(score * demandPenalty);

  if (valves.indCap)
    score = Math.round(score * demandPenalty);

  // Penalize if roads/rail underfunded
  if (budget.roadEffect &lt; budget.MAX_ROAD_EFFECT)
    score -= budget.MAX_ROAD_EFFECT - budget.roadEffect;

  // Penalize player by up to 10% for underfunded police and fire services
  if (budget.policeEffect &lt; budget.MAX_POLICE_STATION_EFFECT)
    score = Math.round(score * (0.9 + (budget.policeEffect / (10 * budget.MAX_POLICE_STATION_EFFECT))));

  if (budget.fireEffect &lt; budget.MAX_FIRE_STATION_EFFECT)
    score = Math.round(score * (0.9 + (budget.fireEffect / (10 * budget.MAX_FIRE_STATION_EFFECT))));

  // Penalise the player by 15% if demand for any type of zone has collapsed due
  // to overprovision
  if (valves.resValve &lt; -1000)
    score = Math.round(score * 0.85);

  if (valves.comValve &lt; -1000)
    score = Math.round(score * 0.85);

  if (valves.indValve &lt; -1000)
    score = Math.round(score * 0.85);

  var scale = 1.0;
  if (this.cityPop === 0 || this.cityPopDelta === 0 || this.cityPopDelta === this.cityPop) {
    // Leave score unchanged if city is empty, if there hasn&#039;t been any migration, if the
    // initial settlers have just arrived, or if the city has doubled in size
    scale = 1.0;
  } else if (this.cityPopDelta &gt; 0) {
    // If the city is growing, scale score by percentage growth in population
    scale = (this.cityPopDelta / this.cityPop) + 1.0;
  } else if (this.cityPopDelta &lt; 0) {
    // If the city is shrinking, scale down by up to 5% based on level of outward migration
    scale = 0.95 + Math.floor(this.cityPopDelta / (this.cityPop - this.cityPopDelta));
  }

  score = Math.round(score * scale);

  // Penalize player for having fires and a burdensome tax rate
  score = score - getFireSeverity(census) - budget.cityTax;

  // Penalize player based on ratio of unpowered zones to total zones
  scale = census.unpoweredZoneCount + census.poweredZoneCount;
  if (scale &gt; 0)
    score = Math.round(score * (census.poweredZoneCount / scale));

  // Force in to range 0-1000. New score is average of last score and new computed value
  score = MiscUtils.clamp(score, 0, 1000);
  this.cityScore = Math.round((this.cityScore + score) / 2);

  this.cityScoreDelta = this.cityScore - cityScoreLast;

  if (this.cityScoreDelta !== 0)
    this._emitEvent(SCORE_UPDATED, this.cityScore);
};


Evaluation.prototype.doVotes = function() {
  // Survey 100 voters on the mayor&#039;s performance
  this.cityYes = 0;

  for (var i = 0; i &lt; 100; i++) {
    var voterExpectation = Random.getRandom(1000);
    if (this.cityScore &gt; voterExpectation)
      this.cityYes++;
  }
};


Evaluation.prototype.getProblemNumber = function(i) {
  if (i &lt; 0 || i &gt;= NUM_COMPLAINTS)
    return null;

  return this.problemOrder[i];
};


Object.defineProperties(Evaluation,
  {CC_VILLAGE: MiscUtils.makeConstantDescriptor(&#039;VILLAGE&#039;),
  CC_TOWN: MiscUtils.makeConstantDescriptor(&#039;TOWN&#039;),
  CC_CITY: MiscUtils.makeConstantDescriptor(&#039;CITY&#039;),
  CC_CAPITAL: MiscUtils.makeConstantDescriptor(&#039;CAPITAL&#039;),
  CC_METROPOLIS: MiscUtils.makeConstantDescriptor(&#039;METROPOLIS&#039;),
  CC_MEGALOPOLIS: MiscUtils.makeConstantDescriptor(&#039;MEGALOPOLIS&#039;),
  CRIME: MiscUtils.makeConstantDescriptor(0),
  POLLUTION: MiscUtils.makeConstantDescriptor(1),
  HOUSING: MiscUtils.makeConstantDescriptor(2),
  TAXES: MiscUtils.makeConstantDescriptor(3),
  TRAFFIC: MiscUtils.makeConstantDescriptor(4),
  UNEMPLOYMENT: MiscUtils.makeConstantDescriptor(5),
  FIRE: MiscUtils.makeConstantDescriptor(6)});
export { Evaluation };</textarea
        >
      </div>
    </div>

    <footer class="footer">
      <div class="container">
        <p>.</p>
      </div>
    </footer>

    <script type="text/html" id="complexity-popover-template">
      <div class="complexity-notice">
        Complexity : {{ cyclomatic }} <br />
        Length : {{ halstead.length }} <br />
        Difficulty : {{ halstead.difficulty.toFixed(2) }} <br />
        Est # bugs : {{ halstead.bugs.toFixed(2) }}<br />
      </div>
    </script>

    <script
      type="text/javascript"
      src="../../assets/scripts/bundles/core-bundle.js"
    ></script>
    <script
      type="text/javascript"
      src="../../assets/scripts/bundles/codemirror.js"
    ></script>
    <script
      type="text/javascript"
      src="../../assets/scripts/codemirror.markpopovertext.js"
    ></script>
    <script type="text/javascript" src="report.js"></script>
    <script type="text/javascript" src="report.history.js"></script>
    <script
      type="text/javascript"
      src="../../assets/scripts/plato-file.js"
    ></script>
  </body>
</html>
