<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Plato - src\boatSprite.js</title>

    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="" />
    <meta name="author" content="" />

    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <link href="../../assets/css/vendor/morris.css" rel="stylesheet" />
    <link href="../../assets/css/vendor/bootstrap.css" rel="stylesheet" />
    <link href="../../assets/css/vendor/font-awesome.css" rel="stylesheet" />
    <link href="../../assets/css/vendor/codemirror.css" rel="stylesheet" />
    <link href="../../assets/css/plato.css" rel="stylesheet" />
    <link href="../../assets/css/plato-file.css" rel="stylesheet" />
  </head>

  <body>
    <div class="navbar navbar-fixed-top">
      <div class="container">
        <a class="navbar-brand" href="http://github.com/es-analysis/plato"
          >Plato on Github</a
        >
        <ul class="nav navbar-nav">
          <li>
            <a href="../../index.html">Report Home</a>
          </li>
        </ul>
      </div>
    </div>

    <div class="jumbotron">
      <div class="container">
        <h1>src\boatSprite.js</h1>
      </div>
    </div>

    <div class="container aggregate-stats">
      <div class="row">
        <div class="col-md-6">
          <h2 class="header">
            Maintainability
            <a
              href="http://blogs.msdn.com/b/codeanalysis/archive/2007/11/20/maintainability-index-range-and-meaning.aspx"
              ><i
                class="icon icon-info-sign"
                rel="popover"
                data-placement="top"
                data-trigger="hover"
                data-content="A value between 0 and 100 that represents the relative ease of maintaining the code. A high value means better maintainability."
                data-original-title="Maintainability Index"
                data-container="body"
              ></i
            ></a>
          </h2>
          <p class="stat">50.54</p>
        </div>
        <div class="col-md-6">
          <h2 class="header">
            Lines of code
            <i
              class="icon icon-info-sign"
              rel="popover"
              data-placement="top"
              data-trigger="hover"
              data-content="Source Lines of Code / Logical Lines of Code"
              data-original-title="SLOC/LSLOC"
              data-container="body"
            ></i>
          </h2>
          <p class="stat">185</p>
        </div>
      </div>
      <div class="row historical">
        <div class="col-md-6">
          <p id="chart_historical_maint" class="chart"></p>
        </div>
        <div class="col-md-6">
          <p id="chart_historical_sloc" class="chart"></p>
        </div>
      </div>
      <div class="row">
        <div class="col-md-6">
          <h2 class="header">
            Difficulty
            <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"
              ><i
                class="icon icon-info-sign"
                rel="popover"
                data-placement="top"
                data-trigger="hover"
                data-content="The difficulty measure is related to the difficulty of the program to write or understand."
                data-original-title="Difficulty"
                data-container="body"
              ></i
            ></a>
          </h2>
          <p class="stat">79.92</p>
        </div>
        <div class="col-md-6">
          <h2 class="header">
            Estimated Errors
            <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"
              ><i
                class="icon icon-info-sign"
                rel="popover"
                data-placement="top"
                data-trigger="hover"
                data-content="Halstead's delivered bugs is an estimate for the number of errors in the implementation."
                data-original-title="Delivered Bugs"
                data-container="body"
              ></i
            ></a>
          </h2>
          <p class="stat">1.74</p>
        </div>
      </div>
    </div>

    <div class="container charts">
      <div class="row">
        <h2 class="header">Function weight</h2>
      </div>
      <div class="row">
        <div class="col-md-6">
          <h3 class="chart-header">
            By Complexity
            <a href="http://en.wikipedia.org/wiki/Cyclomatic_complexity"
              ><i
                class="icon icon-info-sign"
                rel="popover"
                data-placement="top"
                data-trigger="hover"
                data-content="This metric counts the number of distinct paths through a block of code. Lower values are better."
                data-original-title="Cyclomatic Complexity"
                data-container="body"
              ></i
            ></a>
          </h3>
          <div id="fn-by-complexity" class="stat"></div>
        </div>
        <div class="col-md-6">
          <h3 class="chart-header">
            By SLOC
            <i
              class="icon icon-info-sign"
              rel="popover"
              data-placement="top"
              data-trigger="hover"
              data-content="Source Lines of Code / Logical Lines of Code"
              data-original-title="SLOC/LSLOC"
              data-container="body"
            ></i>
          </h3>
          <div id="fn-by-sloc" class="stat"></div>
        </div>
      </div>
    </div>

    <div class="container">
      <div class="row">
        <textarea id="file-source" class="col-md-12">
/* micropolisJS. Adapted by Graeme McCutcheon from Micropolis.
 *
 * This code is released under the GNU GPL v3, with some additional terms.
 * Please see the files LICENSE and COPYING for details. Alternatively,
 * consult http://micropolisjs.graememcc.co.uk/LICENSE and
 * http://micropolisjs.graememcc.co.uk/COPYING
 *
 */

import { BaseSprite } from &#039;./baseSprite&#039;;
import { SHIP_CRASHED, SOUND_HONKHONK } from &#039;./messages&#039;;
import { MiscUtils } from &#039;./miscUtils&#039;;
import { Random } from &#039;./random&#039;;
import { SPRITE_SHIP } from &#039;./spriteConstants&#039;;
import { SpriteConstants } from &#039;./spriteConstants&#039;;
import { SpriteUtils } from &#039;./spriteUtils&#039;;
import * as TileValues from &quot;./tileValues&quot;;

function BoatSprite(map, spriteManager, x, y) {
  this.init(SPRITE_SHIP, map, spriteManager, x, y);
  this.width = 48;
  this.height = 48;
  this.xOffset = -24;
  this.yOffset = -24;

  if (x &lt; SpriteUtils.worldToPix(4))
    this.frame = 3;
  else if (x &gt;= SpriteUtils.worldToPix(map.width - 4))
    this.frame = 7;
  else if (y &lt; SpriteUtils.worldToPix(4))
    this.frame = 5;
  else if (y &gt;= SpriteUtils.worldToPix(map.height - 4))
    this.frame = 1;
  else
    this.frame = 3;

  this.newDir = this.frame;
  this.dir = 10;
  this.count = 1;
}


BaseSprite(BoatSprite);


// This is an odd little function. It returns true if
// oldDir is 180° from newDir and tileValue is underwater
// rail or wire, and returns false otherwise
var oppositeAndUnderwater = function(tileValue, oldDir, newDir) {
  var opposite = oldDir + 4;

  if (opposite &gt; 8)
    opposite -= 8;

  if (newDir != opposite)
    return false;

  if (tileValue == TileValues.POWERBASE || tileValue == TileValues.POWERBASE + 1 ||
      tileValue == TileValues.RAILBASE || tileValue == TileValues.RAILBASE + 1)
    return true;

  return false;
};


var tileDeltaX = [0,  0,  1,  1,  1,  0, -1, -1, -1];
var tileDeltaY = [0, -1, -1,  0,  1,  1,  1,  0, -1];
var xDelta = [0,  0,  2,  2,  2,  0, -2, -2, -2];
var yDelta = [0, -2, -2,  0,  2,  2,  2,  0, -2];
var tileWhiteList = [TileValues.RIVER, TileValues.CHANNEL, TileValues.POWERBASE,
                TileValues.POWERBASE + 1, TileValues.RAILBASE,
                TileValues.RAILBASE + 1, TileValues.BRWH, TileValues.BRWV];

var CANTMOVE = 10;

BoatSprite.prototype.move = function(spriteCycle, disasterManager, blockMaps) {
  var tile = TileValues.RIVER;
  var frame, x, y;

  if (this.soundCount &gt; 0)
    this.soundCount--;

  if (this.soundCount === 0) {
    if ((Random.getRandom16() &amp; 3) === 1) {
      // TODO Scenarios
      // TODO Sound
      this._emitEvent(SOUND_HONKHONK);
    }

    this.soundCount = 200;
  }

  if (this.count &gt; 0)
      this.count--;


  if (this.count === 0) {
    // Ships turn slowly: only 45° every 9 cycles
    this.count = 9;

    // If already executing a turn, continue to do so
    if (this.frame !== this.newDir) {
      this.frame = SpriteUtils.turnTo(this.frame, this.newDir);
      return;
    }

    // Otherwise pick a new direction
    // Choose a random starting direction to search from
    // 0 = N, 1 = NE, ... 7 = NW
    var startDir = Random.getRandom16() &amp; 7;

    for (var dir = startDir; dir &lt; (startDir + 8); dir++) {
      frame = (dir &amp; 7) + 1;

      if (frame === this.dir)
        continue;

      x = this.worldX + tileDeltaX[frame];
      y = this.worldY + tileDeltaY[frame];

      if (this.map.testBounds(x, y)) {
        tile = this.map.getTileValue(x, y);

        // Test for a suitable water tile
        if (tile === TileValues.CHANNEL || tile === TileValues.BRWH ||
            tile === TileValues.BRWV || oppositeAndUnderwater(tile, this.dir, frame)) {
          this.newDir = frame;
          this.frame = SpriteUtils.turnTo(this.frame, this.newDir);
          this.dir = frame + 4;

          if (this.dir &gt; 8)
            this.dir -= 8;
          break;
        }
      }
    }

    if (dir === (startDir + 8)) {
      this.dir = CANTMOVE;
      this.newDir = (Random.getRandom16() &amp; 7) + 1;
    }
  } else {
    frame = this.frame;

    if (frame === this.newDir)  {
      this.x += xDelta[frame];
      this.y += yDelta[frame];
    }
  }

  if (this.spriteNotInBounds()) {
    this.frame = 0;
    return;
  }

  // If we didn&#039;t find a new direction, we might explode
  // depending on the last tile we looked at.
  for (var i = 0; i &lt; 8; i++) {
    if (tile === tileWhiteList[i]) {
      break;
    }

    if (i === 7) {
      this.explodeSprite();
      SpriteUtils.destroyMapTile(this.spriteManager, this.map, blockMaps, this.x, this.y);
    }
  }
};


BoatSprite.prototype.explodeSprite = function() {
  this.frame = 0;
  this.spriteManager.makeExplosionAt(this.x, this.y);
  this._emitEvent(SHIP_CRASHED, {showable: true, x: this.worldX, y: this.worldY});
};


// Metadata for image loading
Object.defineProperties(BoatSprite,
  {ID: MiscUtils.makeConstantDescriptor(4),
   width: MiscUtils.makeConstantDescriptor(48),
   frames: MiscUtils.makeConstantDescriptor(8)});


export { BoatSprite };</textarea
        >
      </div>
    </div>

    <footer class="footer">
      <div class="container">
        <p>.</p>
      </div>
    </footer>

    <script type="text/html" id="complexity-popover-template">
      <div class="complexity-notice">
        Complexity : {{ cyclomatic }} <br />
        Length : {{ halstead.length }} <br />
        Difficulty : {{ halstead.difficulty.toFixed(2) }} <br />
        Est # bugs : {{ halstead.bugs.toFixed(2) }}<br />
      </div>
    </script>

    <script
      type="text/javascript"
      src="../../assets/scripts/bundles/core-bundle.js"
    ></script>
    <script
      type="text/javascript"
      src="../../assets/scripts/bundles/codemirror.js"
    ></script>
    <script
      type="text/javascript"
      src="../../assets/scripts/codemirror.markpopovertext.js"
    ></script>
    <script type="text/javascript" src="report.js"></script>
    <script type="text/javascript" src="report.history.js"></script>
    <script
      type="text/javascript"
      src="../../assets/scripts/plato-file.js"
    ></script>
  </body>
</html>
