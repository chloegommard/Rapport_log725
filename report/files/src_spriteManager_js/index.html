<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Plato - src\spriteManager.js</title>

    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="" />
    <meta name="author" content="" />

    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <link href="../../assets/css/vendor/morris.css" rel="stylesheet" />
    <link href="../../assets/css/vendor/bootstrap.css" rel="stylesheet" />
    <link href="../../assets/css/vendor/font-awesome.css" rel="stylesheet" />
    <link href="../../assets/css/vendor/codemirror.css" rel="stylesheet" />
    <link href="../../assets/css/plato.css" rel="stylesheet" />
    <link href="../../assets/css/plato-file.css" rel="stylesheet" />
  </head>

  <body>
    <div class="navbar navbar-fixed-top">
      <div class="container">
        <a class="navbar-brand" href="http://github.com/es-analysis/plato"
          >Plato on Github</a
        >
        <ul class="nav navbar-nav">
          <li>
            <a href="../../index.html">Report Home</a>
          </li>
        </ul>
      </div>
    </div>

    <div class="jumbotron">
      <div class="container">
        <h1>src\spriteManager.js</h1>
      </div>
    </div>

    <div class="container aggregate-stats">
      <div class="row">
        <div class="col-md-6">
          <h2 class="header">
            Maintainability
            <a
              href="http://blogs.msdn.com/b/codeanalysis/archive/2007/11/20/maintainability-index-range-and-meaning.aspx"
              ><i
                class="icon icon-info-sign"
                rel="popover"
                data-placement="top"
                data-trigger="hover"
                data-content="A value between 0 and 100 that represents the relative ease of maintaining the code. A high value means better maintainability."
                data-original-title="Maintainability Index"
                data-container="body"
              ></i
            ></a>
          </h2>
          <p class="stat">66.01</p>
        </div>
        <div class="col-md-6">
          <h2 class="header">
            Lines of code
            <i
              class="icon icon-info-sign"
              rel="popover"
              data-placement="top"
              data-trigger="hover"
              data-content="Source Lines of Code / Logical Lines of Code"
              data-original-title="SLOC/LSLOC"
              data-container="body"
            ></i>
          </h2>
          <p class="stat">285</p>
        </div>
      </div>
      <div class="row historical">
        <div class="col-md-6">
          <p id="chart_historical_maint" class="chart"></p>
        </div>
        <div class="col-md-6">
          <p id="chart_historical_sloc" class="chart"></p>
        </div>
      </div>
      <div class="row">
        <div class="col-md-6">
          <h2 class="header">
            Difficulty
            <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"
              ><i
                class="icon icon-info-sign"
                rel="popover"
                data-placement="top"
                data-trigger="hover"
                data-content="The difficulty measure is related to the difficulty of the program to write or understand."
                data-original-title="Difficulty"
                data-container="body"
              ></i
            ></a>
          </h2>
          <p class="stat">75.00</p>
        </div>
        <div class="col-md-6">
          <h2 class="header">
            Estimated Errors
            <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"
              ><i
                class="icon icon-info-sign"
                rel="popover"
                data-placement="top"
                data-trigger="hover"
                data-content="Halstead's delivered bugs is an estimate for the number of errors in the implementation."
                data-original-title="Delivered Bugs"
                data-container="body"
              ></i
            ></a>
          </h2>
          <p class="stat">3.52</p>
        </div>
      </div>
    </div>

    <div class="container charts">
      <div class="row">
        <h2 class="header">Function weight</h2>
      </div>
      <div class="row">
        <div class="col-md-6">
          <h3 class="chart-header">
            By Complexity
            <a href="http://en.wikipedia.org/wiki/Cyclomatic_complexity"
              ><i
                class="icon icon-info-sign"
                rel="popover"
                data-placement="top"
                data-trigger="hover"
                data-content="This metric counts the number of distinct paths through a block of code. Lower values are better."
                data-original-title="Cyclomatic Complexity"
                data-container="body"
              ></i
            ></a>
          </h3>
          <div id="fn-by-complexity" class="stat"></div>
        </div>
        <div class="col-md-6">
          <h3 class="chart-header">
            By SLOC
            <i
              class="icon icon-info-sign"
              rel="popover"
              data-placement="top"
              data-trigger="hover"
              data-content="Source Lines of Code / Logical Lines of Code"
              data-original-title="SLOC/LSLOC"
              data-container="body"
            ></i>
          </h3>
          <div id="fn-by-sloc" class="stat"></div>
        </div>
      </div>
    </div>

    <div class="container">
      <div class="row">
        <textarea id="file-source" class="col-md-12">
/* micropolisJS. Adapted by Graeme McCutcheon from Micropolis.
 *
 * This code is released under the GNU GPL v3, with some additional terms.
 * Please see the files LICENSE and COPYING for details. Alternatively,
 * consult http://micropolisjs.graememcc.co.uk/LICENSE and
 * http://micropolisjs.graememcc.co.uk/COPYING
 *
 */

import { AirplaneSprite } from &#039;./airplaneSprite&#039;;
import { BoatSprite } from &#039;./boatSprite&#039;;
import { CopterSprite } from &#039;./copterSprite&#039;;
import { EventEmitter } from &#039;./eventEmitter&#039;;
import { ExplosionSprite } from &#039;./explosionSprite&#039;;
import * as Messages from &#039;./messages&#039;;
import { MiscUtils } from &#039;./miscUtils&#039;;
import { MonsterSprite } from &#039;./monsterSprite&#039;;
import { Random } from &#039;./random&#039;;
import * as SpriteConstants from &#039;./spriteConstants&#039;;
import { SpriteUtils } from &#039;./spriteUtils&#039;;
import { CHANNEL, RIVER } from &quot;./tileValues&quot;;
import { TornadoSprite } from &#039;./tornadoSprite&#039;;
import { TrainSprite } from &#039;./trainSprite&#039;;

var SpriteManager = EventEmitter(function(map) {
  this.spriteList = [];
  this.map = map;
  this.spriteCycle = 0;
});


SpriteManager.prototype.getSprite = function(type) {
  var filteredList = this.spriteList.filter(function (s) {
    return s.frame !== 0 &amp;&amp; s.type === type;
  });

  if (filteredList.length === 0)
    return null;

  return filteredList[0];
};


SpriteManager.prototype.getSpriteList = function() {
  return this.spriteList.slice();
};


SpriteManager.prototype.getSpritesInView = function(startX, startY, pixelWidth, pixelHeight) {
  var sprites = [];
  startX = SpriteUtils.worldToPix(startX);
  startY = SpriteUtils.worldToPix(startY);
  var lastX = startX + pixelWidth;
  var lastY = startY + pixelHeight;

  return this.spriteList.filter(function(s) {
    var spriteLeft = s.x + s.xOffset;
    var spriteTop = s.y + s.yOffset;
    var spriteRight = s.x + s.xOffset + s.width;
    var spriteBottom = s.y + s.yOffset + s.width;

    var leftInBounds = spriteLeft &gt;= startX &amp;&amp; spriteLeft &lt; lastX;
    var rightInBounds = spriteRight &gt;= startX &amp;&amp; spriteRight &lt; lastX;
    var topInBounds = spriteTop &gt;= startY &amp;&amp; spriteTop &lt; lastY;
    var bottomInBounds = spriteBottom &gt;= startY &amp;&amp; spriteBottom &lt; lastY;

    return (leftInBounds || rightInBounds) &amp;&amp; (topInBounds || bottomInBounds);
  });
};


SpriteManager.prototype.moveObjects = function(simData) {
  var disasterManager = simData.disasterManager;
  var blockMaps = simData.blockMaps;

  this.spriteCycle += 1;

  var list = this.spriteList.slice();

  for (var i = 0, l = list.length; i &lt; l; i++) {
    var sprite = list[i];

    if (sprite.frame === 0)
      continue;

    sprite.move(this.spriteCycle, disasterManager, blockMaps);
  }

  this.pruneDeadSprites();
};


SpriteManager.prototype.makeSprite = function(type, x, y) {
  var newSprite = new constructors[type](this.map, this, x, y);

  // Listen for crashes
  for (var i = 0, l = Messages.CRASHES.length; i &lt; l; i++)
    newSprite.addEventListener(Messages.CRASHES[i], MiscUtils.reflectEvent.bind(this, Messages.CRASHES[i]));

  if (type == SpriteConstants.SPRITE_HELICOPTER)
    newSprite.addEventListener(Messages.HEAVY_TRAFFIC, MiscUtils.reflectEvent.bind(this, Messages.HEAVY_TRAFFIC));

  this.spriteList.push(newSprite);
  return newSprite;
};


SpriteManager.prototype.makeTornado = function() {
  var sprite = this.getSprite(SpriteConstants.SPRITE_TORNADO);
  if (sprite !== null) {
    sprite.count = 200;
    this._emitEvent(Messages.TORNADO_SIGHTED, {trackable: true, x: sprite.worldX, y: sprite.worldY, sprite: sprite});
    return;
  }

  var x = Random.getRandom(SpriteUtils.worldToPix(this.map.width) - 800) + 400;
  var y = Random.getRandom(SpriteUtils.worldToPix(this.map.height) - 200) + 100;

  sprite = this.makeSprite(SpriteConstants.SPRITE_TORNADO, x, y);
  this._emitEvent(Messages.TORNADO_SIGHTED, {trackable: true, x: sprite.worldX, y: sprite.worldY, sprite: sprite});
};


SpriteManager.prototype.makeExplosion = function(x, y) {
  if (this.map.testBounds(x, y))
    this.makeExplosionAt(SpriteUtils.worldToPix(x), SpriteUtils.worldToPix(y));
};


SpriteManager.prototype.makeExplosionAt = function(x, y) {
  this.makeSprite(SpriteConstants.SPRITE_EXPLOSION, x, y);
};


SpriteManager.prototype.generatePlane = function(x, y) {
  if (this.getSprite(SpriteConstants.SPRITE_AIRPLANE) !== null)
    return;

  this.makeSprite(SpriteConstants.SPRITE_AIRPLANE,
                  SpriteUtils.worldToPix(x),
                  SpriteUtils.worldToPix(y));
};


SpriteManager.prototype.generateTrain = function(census, x, y) {
  if (census.totalPop &gt; 10 &amp;&amp;
      this.getSprite(SpriteConstants.SPRITE_TRAIN) === null &amp;&amp;
      Random.getRandom(25) === 0)
    this.makeSprite(SpriteConstants.SPRITE_TRAIN,
                    SpriteUtils.worldToPix(x) + 8,
                    SpriteUtils.worldToPix(y) + 8);
};


SpriteManager.prototype.generateShip = function() {
  // XXX This code is borked. The map generator will never
  // place a channel tile on the edges of the map
  var x,y;

  if (Random.getChance(3)) {
    for (x = 4; x &lt; this.map.width - 2; x++) {
      if (this.map.getTileValue(x, 0) === CHANNEL)  {
        this.makeShipHere(x, 0);
        return;
      }
    }
  }

  if (Random.getChance(3)) {
    for (y = 1; y &lt; this.map.height - 2; y++) {
      if (this.map.getTileValue(0, y) === CHANNEL)  {
        this.makeShipHere(0, y);
        return;
      }
    }
  }

  if (Random.getChance(3)) {
    for (x = 4; x &lt; this.map.width - 2; x++) {
      if (this.map.getTileValue(x, this.map.height - 1) === CHANNEL)  {
        this.makeShipHere(x, this.map.height - 1);
        return;
      }
    }
  }

  if (Random.getChance(3)) {
    for (y = 1; y &lt; this.map.height - 2; y++) {
      if (this.map.getTileValue(this.map.width - 1, y) === CHANNEL)  {
        this.makeShipHere(this.map.width - 1, y);
        return;
      }
    }
  }
};


SpriteManager.prototype.getBoatDistance = function(x, y) {
  var dist = 99999;
  var pixelX = SpriteUtils.worldToPix(x) + 8;
  var pixelY = SpriteUtils.worldToPix(y) + 8;

  for (var i = 0, l = this.spriteList.length; i &lt; l; i++) {
    var sprite = this.spriteList[i];
    if (sprite.type === SpriteConstants.SPRITE_SHIP &amp;&amp; sprite.frame !== 0) {
      var sprDist = Math.abs(sprite.x - pixelX) + Math.abs(sprite.y - pixelY);

      dist = Math.min(dist, sprDist);
    }
  }

  return dist;
};


SpriteManager.prototype.makeShipHere = function(x, y) {
  this.makeSprite(SpriteConstants.SPRITE_SHIP,
                  SpriteUtils.worldToPix(x),
                  SpriteUtils.worldToPix(y));
};


SpriteManager.prototype.generateCopter = function(x, y) {
  if (this.getSprite(SpriteConstants.SPRITE_HELICOPTER) !== null)
    return;

  this.makeSprite(SpriteConstants.SPRITE_HELICOPTER,
                  SpriteUtils.worldToPix(x),
                  SpriteUtils.worldToPix(y));
};


SpriteManager.prototype.makeMonsterAt = function(x, y) {
  var sprite = this.makeSprite(SpriteConstants.SPRITE_MONSTER,
                  SpriteUtils.worldToPix(x),
                  SpriteUtils.worldToPix(y));
  this._emitEvent(Messages.MONSTER_SIGHTED, {trackable: true, x: x, y: y, sprite: sprite});
};


SpriteManager.prototype.makeMonster = function() {
  var sprite = this.getSprite(SpriteConstants.SPRITE_MONSTER);
  if (sprite !== null) {
    sprite.soundCount = 1;
    sprite.count = 1000;
    sprite.destX = SpriteUtils.worldToPix(this.map.pollutionMaxX);
    sprite.destY = SpriteUtils.worldToPix(this.map.pollutionMaxY);
  }

  var done = 0;
  for (var i = 0; i &lt; 300; i++)  {
    var x = Random.getRandom(this.map.width - 20) + 10;
    var y = Random.getRandom(this.map.height - 10) + 5;

    var tile = this.map.getTile(x, y);
    if (tile.getValue() === RIVER) {
      this.makeMonsterAt(x, y);
      done = 1;
      break;
    }
  }

  if (done === 0)
    this.makeMonsterAt(60, 50);
};


SpriteManager.prototype.pruneDeadSprites = function(type) {
  this.spriteList = this.spriteList.filter(function (s) {
    return s.frame !== 0;
  });
};


var constructors = {};
constructors[SpriteConstants.SPRITE_TRAIN] = TrainSprite;
constructors[SpriteConstants.SPRITE_SHIP] = BoatSprite;
constructors[SpriteConstants.SPRITE_MONSTER] = MonsterSprite;
constructors[SpriteConstants.SPRITE_HELICOPTER] = CopterSprite;
constructors[SpriteConstants.SPRITE_AIRPLANE] = AirplaneSprite;
constructors[SpriteConstants.SPRITE_TORNADO] = TornadoSprite;
constructors[SpriteConstants.SPRITE_EXPLOSION] = ExplosionSprite;


export { SpriteManager };</textarea
        >
      </div>
    </div>

    <footer class="footer">
      <div class="container">
        <p>.</p>
      </div>
    </footer>

    <script type="text/html" id="complexity-popover-template">
      <div class="complexity-notice">
        Complexity : {{ cyclomatic }} <br />
        Length : {{ halstead.length }} <br />
        Difficulty : {{ halstead.difficulty.toFixed(2) }} <br />
        Est # bugs : {{ halstead.bugs.toFixed(2) }}<br />
      </div>
    </script>

    <script
      type="text/javascript"
      src="../../assets/scripts/bundles/core-bundle.js"
    ></script>
    <script
      type="text/javascript"
      src="../../assets/scripts/bundles/codemirror.js"
    ></script>
    <script
      type="text/javascript"
      src="../../assets/scripts/codemirror.markpopovertext.js"
    ></script>
    <script type="text/javascript" src="report.js"></script>
    <script type="text/javascript" src="report.history.js"></script>
    <script
      type="text/javascript"
      src="../../assets/scripts/plato-file.js"
    ></script>
  </body>
</html>
